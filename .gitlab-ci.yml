image: ruby:2.4.1

stages:
  - test
  - deploy

variables:
  APP_NAME:             'Rails-Auth0'
  BUNDLER_VERSION:      '1.13.7'

  POSTGRES_DB:          'rails_auth0'
  POSTGRES_USER:        'runner'
  POSTGRES_PASSWORD:    ''

  # The following will be used in config/database.yml
  DATABASE_HOST:        'postgres'
  DATABASE_NAME:        $POSTGRES_DB
  DATABASE_USERNAME:    $POSTGRES_USER
  DATABASE_PASSWORD:    $POSTGRES_PASSWORD

  REDIS_URL:            'redis://localhost:6379/0'

  DISPLAY:              ':99'
  SPEC_RETRIES:         '3'

before_script:
  - apt-get update -qy
  - apt-get install -y nodejs # wkhtmltopdf xvfb
  - apt-get install -y -qq postgresql postgresql-contrib libpq-dev cmake
  - apt-get install -y redis-server

  - uname -a
  - ruby -v
  - which ruby
  - which pg_dump
  - pg_dump --version
  - export

  # https://devcenter.heroku.com/articles/ruby-support#libraries
  # Bundler version used by Heroku is 1.13.7
  - gem install bundler --no-ri --no-rdoc -v $BUNDLER_VERSION
  - bundle install --deployment --jobs $(nproc) --path vendor/bundle

rubocop:
  stage: test
  script:
    - bundle exec rubocop
  allow_failure: true

audit_gems:
  stage: test
  script:
    - bundle exec bundle-audit update
    - bundle exec bundle-audit -v
  allow_failure: false

brakeman:
  stage: test
  script:
    - bundle exec brakeman --no-progress
  allow_failure: false

rspec:
  stage: test

  cache:
    key: 'bundle'
    paths:
      - vendor/bundle

  services:
   - postgres:9.4.10
   - redis:latest

  script:
    - bundle exec rake db:drop    RAILS_ENV=test || true
    - bundle exec rake db:create  RAILS_ENV=test
    - bundle exec rake db:migrate RAILS_ENV=test
    - bundle exec rake db:seed    RAILS_ENV=test
    - bundle exec rspec spec

#-----------------------------------------------------------------------------
# Deployment
#
# https://docs.gitlab.com/ce/ci/yaml/#special-yaml-features
.deploy_with_dpl: &dpl # Hidden key that defines an anchor named 'dpl'
  script:
    - gem install dpl -v '1.8.31' --no-ri --no-rdoc
    - dpl --provider=heroku --app=$HEROKU_APP_NAME --api-key=$HEROKU_API_KEY

staging:
  <<: *dpl
  variables:
    - HEROKU_APP_NAME: $HEROKU_STAGING_APP_NAME
  stage: deploy
  only:
    - master

# To deploy to production, create a Merge Request from master branch to production branch.
production:
  <<: *dpl
  variables:
    - HEROKU_APP_NAME: $HEROKU_PRODUCTION_APP_NAME
  stage: deploy
  only:
    - production
